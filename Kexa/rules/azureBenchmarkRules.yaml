- version: 1.0.0
  date: 07-18-2023
  alert:
    fatal:
      enabled: true
      type: 
        - log
        #- email
      to:
        - myEmail@gmail.com
    error:
      enabled: true
      type: 
        - log
        #- email
        #- sms
      to: 
        - myEmail@gmail.com
    warning:
      enabled: true
      type: 
        - log
        #- email
      to:
        - myEmail@gmail.com
    info:
      enabled: true
      type: 
        - log
        #- email
      to: 
        - myEmail@gmail.com
    global:
      enabled: true
      type: 
        - log
        #- email
        #- webhook
        #- sms
      to: 
        #- http://127.0.0.1:5000/test
        #- myEmail@gmail.com
      conditions:
        - level: 0
          min: 1
        - level: 1
          min: 1
        - level: 2
          min: 1
        - level: 3
          min: 1
  rules:
    ##################################
    #            STORAGES            #
    ##################################
    #### storage accounts
    - name: "azure-storage-acc-public-network-access"
      description: "this rule to ensure that public network access is disabled for storage accounts"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: StorageManagementClient.storageAccounts
      conditions:
        - property: publicNetworkAccess
          condition: DIFFERENT
          value: 'Enabled'
    - name: "azure-storage-secure-transfer"
      description: "this rule to ensure that secure transfer is enabled for storage accounts"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: StorageManagementClient.storageAccounts
      conditions:
        - property: enableHttpsTrafficOnly
          condition: EQUAL
          value: true
    - name: "azure-storage-require-infra-encryption"
      description: "this rule to ensure storage accounts require infrastructure encryption"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: StorageManagementClient.storageAccounts
      conditions:
        - property: encryption.requireInfrastructureEncryption
          condition: EQUAL
          value: true
    - name: "azure-storage-network-default-deny-traffic"
      description: "this rule to ensure storage accounts networks default deny all traffic"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: StorageManagementClient.storageAccounts
      conditions:
        - property: networkRuleSet.defaultAction
          condition: EQUAL
          value: 'Deny'
    - name: "azure-storage-use-private-endpoint"
      description: "this rule to ensure storage accounts use private endpoints connections"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: StorageManagementClient.storageAccounts
      conditions:
        - property: privateEndpointConnections
          condition: COUNT_SUP_OR_EQUAL
          value: 1
    - name: "azure-storage-minimum-tls-version"
      description: "this rule to ensure storage accounts set minimum TLS version to 1.2"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: StorageManagementClient.storageAccounts
      conditions:
        - property: minimumTlsVersion
          condition: EQUAL
          value: 'TLS1_2'
    - name: "azure-storage-cross-tenant-replication-disabled"
      description: "this rule to ensure cross storage replication is disabled for storage accounts"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: StorageManagementClient.storageAccounts
      conditions:
        - property: allowCrossTenantReplication
          condition: DIFFERENT
          value: true
    - name: "azure-storage-blob-public-access"
      description: "this rule to ensure public bloc access is disabled for storage accounts"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: StorageManagementClient.storageAccounts
      conditions:
        - property: allowBlobPublicAccess
          condition: DIFFERENT
          value: true
    - name: "azure-storage-encrypte-with-cmk"
      description: "this rule to ensure storage accounts use CMK encryption for critical data"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: StorageManagementClient.storageAccounts
      conditions:
        - property: encryption.keySource
          condition: EQUAL
          value: 'Microsoft.Keyvault'
    # retest here
    - name: "azure-storage-blob-soft-delete"
      description: "this rule to ensure storage containers delete retention"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: KexaAzure.blobServices
      conditions:
        - operator: AND
          criteria:
            - property: deleteRetentionPolicy.enabled
              condition: EQUAL
              value: true
            - property: deleteRetentionPolicy.days
              condition: SUP_OR_EQUAL
              value: 1
    # retest here
    - name: "azure-storage-container-soft-delete"
      description: "this rule to ensure storage "
      applied: false
      level: 1
      cloudProvider: azure
      objectName: KexaAzure.blobServices
      conditions:
        - operator: AND
          criteria:
            - property: containerDeleteRetentionPolicy.enabled
              condition: EQUAL
              value: true
            - property: deleteRetentionPolicy.days
              condition: SUP_OR_EQUAL
              value: 1
    ##################################
    #     VAULTS, SECRETS, KEYS      #
    ##################################
    #### vaults configuration
    - name: "azure-vault-no-public-network-access"
      description: "this rule is to ensure vault network public access is disabled"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: KexaAzure.vaults
      conditions:
        - property: properties.publicNetworkAccess
          condition: EQUAL
          value: 'Disabled'
    - name: "azure-ensure-rbac-enabled"
      description: "this rule is to ensure rbac is enabled for kayvaults"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: KexaAzure.vaults
      conditions:
        - property: properties.enableRbacAuthorization
          condition: EQUAL
          value: true
    - name: "azure-ensure-use-private-endpoint"
      description: "this rule is to ensure private endpoints are used for Keyvault"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: KexaAzure.vaults
      conditions:
        - property: properties.privateEndpointConnections
          condition: ALL
          value:
            - property: id
              condition: DIFFERENT
              value: null
    - name: "azure-ensure-keyvault-recoverable"
      description: "this rule is to ensure keyvaults are recoverable"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: KexaAzure.vaults
      conditions:
        - property: properties.enablePurgeProtection
          condition: EQUAL
          value: true
    #### vault secrets
    - name: "azure-secrets-ensure-expiration"
      description: "this rule is to ensure every secrets has an expiration date"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: KexaAzure.secrets
      conditions:
        - property: properties.attributes.expires
          condition: DIFFERENT
          value: null
    #### vault keys
    - name: "azure-vault-keys-rotation"
      description: "this rule is to ensure every keys has a rotation defined"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: KexaAzure.KeyvaultKeys
      conditions:
        - property: properties.rotationPolicy
          condition: DIFFERENT
          value: null
    - name: "azure-vault-keys-expiration-date"
      description: "this rule is to ensure every keys has a expiration date"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: KexaAzure.KeyvaultKeys
      conditions:
        - property: properties.attributes.expires
          condition: DIFFERENT
          value: null
    ##################################
    #           APP INSIGHT          #
    ##################################
    # app configurations
    - name: "azure-ensure-app-insight-configured"
      description: "this rule is to ensure app insights is configured"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: ApplicationInsightsManagementClient.components
      conditions:
        - property: .
          condition: COUNT_SUP_OR_EQUAL
          value: 1
    # resources monitoring
    - name: "azure-ensure-azure-monitor-resources-logging-enabled"
      description: "this rule is to ensure all resources that support azure monitoring are monitored by app insights"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: KexaAzure.monitor
      conditions:
        - property: diagnosticSettings
          condition: COUNT_SUP_OR_EQUAL
          value: 1
    ##################################
    #         SQL / POSTGRES         #
    ##################################
    #### sql servers
    - name: "azure-sql-server-firewall-any-ip"
      description: "this rule is to ensure SQL servers firewall does not allow any IP"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: KexaAzure.sqlServers
      conditions:
      - operator: OR
        criteria:
          - property: 'publicNetworkAccess'
            condition: EQUAL
            value: 'Disabled'
          - property: firewallRules
            condition: ALL
            value:
              - property: startIpAddress
                condition: DIFFERENT
                value: '0.0.0.0'
              - property: endIpAddress
                operator: AND
                criteria:
                  - property: .
                    condition: DIFFERENT
                    value: '0.0.0.0'
                  - property: .
                    condition: DIFFERENT
                    value: '255.255.255.255'
    - name: "azure-sql-servers-encryption-protector-customer-managed-key"
      description: "this rule is to ensure sql servers encryption protector is customer managed key"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: KexaAzure.sqlServers
      conditions:
        - property: encryptionProtectors
          condition: ALL
          value:
            - property: kind
              condition: EQUAL
              value: 'azurekeyvault'
            - property: serverKeyType
              condition: DIFFERENT
              value: 'AzureKeyVault'
            - property: uri
              condition: DIFFERENT
              value: null
    - name: "azure-sql-servers-entra-id-administrator"
      description: "this rule is to ensure entra id authentication is configured for sql servers"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: KexaAzure.sqlServers
      conditions:
        - property: administrators.administratorType
          condition: EQUAL
          value: 'ActiveDirectory'
        - property: administrators.azureADOnlyAuthentication
          condition: EQUAL
          value: true
    - name: "azure-sql-servers-retention-more-than-90-days"
      description: "this rule is to ensure sql servers audit logs retention is unlimited (0) or more than 90 days"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: KexaAzure.sqlServers
      conditions:
        - property: blobAuditingPolicies
          condition: ALL
          value:
            - property: retentionDays
              condition: REGEX
              value: ^(0|[9][0-9]+)$
            - property: state
              condition: EQUAL
              value: 'Enabled'
    - name: "azure-sql-servers-auditing"
      description: "this rule is to ensure sql servers auditing is enabled"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: KexaAzure.sqlServers
      conditions:
        - property: serverDevOpsAuditSettings
          condition: ALL
          value:
            - property: state
              condition: EQUAL
              value: 'Enabled'
        - property: blobAuditingPolicies
          condition: ALL
          value:
            - property: state
              condition: EQUAL
              value: 'Enabled'
    #### sql databases
    - name: "azure-sql-database-tde-enabled"
      description: "this rule is to ensure sql databases auditing is enabled"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: KexaAzure.sqlDatabases
      conditions:
        - property: transparentDataEncryptions
          condition: ALL
          value:
            - property: state
              condition: EQUAL
              value: 'Enabled'
    # ko 
    - name: "azure-sql-database-ssl-connection-required"
      description: "this rule is to ensure sql databases SSL connection is required"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: KexaAzure.sqlDatabases
      conditions:
        - property: transparentDataEncryptions
          condition: ALL
          value:
            - property: state
              condition: EQUAL
              value: 'Enabled'
    ##### postgres servers
    # ko
    - name: "azure-postgres-server-firewall-any-ip"
      description: "this rule is to ensure postgres servers firewall does not allow any IP"
      applied: false
      level: 1
      cloudProvider: azure
      objectName: KexaAzure.postgresServers
      conditions:
        - property: firewallRules
          condition: EQUAL
          value: 'e'
    ##################################
    #         GLOBAL / GRAPH         #
    ##################################
    - name: "azure-global-ensure-azure-ad-authentication"
      description: "this rule is to ensure azure ad authentication is enabled"
      applied: true
      level: 1
      cloudProvider: azure
      objectName: KexaAzure.global
      conditions:
        - property: authMethods
          condition: ONE
          value:
            - property: 'AzureAD'
            - name: "azure-global-ensure-mfa"
            - value: 'dqzdqz'